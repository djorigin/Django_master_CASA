{% extends 'aircraft/base.html' %}
{% load static %}

{% block page_title %}
    {% if title %}{{ title }}{% else %}Operational Area Form{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        <i class="fas fa-map-marker-alt me-2"></i>
                        {{ title|default:"Operational Area Form" }}
                    </h2>
                    {% if operational_area %}
                    <p class="text-muted mb-0">{{ operational_area.area_id }} - {{ operational_area.name }}</p>
                    {% endif %}
                </div>
                <div>
                    <a href="{% url 'airspace:operational_area_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to List
                    </a>
                    {% if operational_area %}
                    <a href="{% url 'airspace:operational_area_detail' operational_area.pk %}" class="btn btn-outline-primary">
                        <i class="fas fa-eye me-2"></i>View Details
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Form -->
            <div class="card">
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Basic Information
                                </h5>
                            </div>
                            
                            <!-- Area ID -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.area_id.id_for_label }}" class="form-label">
                                    {{ form.area_id.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.area_id }}
                                {% if form.area_id.help_text %}
                                <div class="form-text">{{ form.area_id.help_text }}</div>
                                {% endif %}
                                {% if form.area_id.errors %}
                                <div class="text-danger small">{{ form.area_id.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Name -->
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    {{ form.name.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.help_text %}
                                <div class="form-text">{{ form.name.help_text }}</div>
                                {% endif %}
                                {% if form.name.errors %}
                                <div class="text-danger small">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Area Type -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.area_type.id_for_label }}" class="form-label">
                                    {{ form.area_type.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.area_type }}
                                {% if form.area_type.help_text %}
                                <div class="form-text">{{ form.area_type.help_text }}</div>
                                {% endif %}
                                {% if form.area_type.errors %}
                                <div class="text-danger small">{{ form.area_type.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Airspace Class -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.airspace_class.id_for_label }}" class="form-label">
                                    {{ form.airspace_class.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.airspace_class }}
                                {% if form.airspace_class.help_text %}
                                <div class="form-text">{{ form.airspace_class.help_text }}</div>
                                {% endif %}
                                {% if form.airspace_class.errors %}
                                <div class="text-danger small">{{ form.airspace_class.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Geographic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-globe me-2"></i>Geographic Information
                                </h5>
                            </div>

                            <!-- Center Latitude -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.center_latitude.id_for_label }}" class="form-label">
                                    {{ form.center_latitude.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.center_latitude }}
                                {% if form.center_latitude.help_text %}
                                <div class="form-text">{{ form.center_latitude.help_text }}</div>
                                {% endif %}
                                {% if form.center_latitude.errors %}
                                <div class="text-danger small">{{ form.center_latitude.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Center Longitude -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.center_longitude.id_for_label }}" class="form-label">
                                    {{ form.center_longitude.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.center_longitude }}
                                {% if form.center_longitude.help_text %}
                                <div class="form-text">{{ form.center_longitude.help_text }}</div>
                                {% endif %}
                                {% if form.center_longitude.errors %}
                                <div class="text-danger small">{{ form.center_longitude.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Radius -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.radius_nautical_miles.id_for_label }}" class="form-label">
                                    {{ form.radius_nautical_miles.label }}
                                </label>
                                {{ form.radius_nautical_miles }}
                                {% if form.radius_nautical_miles.help_text %}
                                <div class="form-text">{{ form.radius_nautical_miles.help_text }}</div>
                                {% endif %}
                                {% if form.radius_nautical_miles.errors %}
                                <div class="text-danger small">{{ form.radius_nautical_miles.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Altitude Restrictions -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-arrows-alt-v me-2"></i>Altitude Restrictions
                                </h5>
                            </div>

                            <!-- Floor Altitude AMSL -->
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.floor_altitude_amsl.id_for_label }}" class="form-label">
                                    {{ form.floor_altitude_amsl.label }}
                                </label>
                                {{ form.floor_altitude_amsl }}
                                {% if form.floor_altitude_amsl.help_text %}
                                <div class="form-text">{{ form.floor_altitude_amsl.help_text }}</div>
                                {% endif %}
                                {% if form.floor_altitude_amsl.errors %}
                                <div class="text-danger small">{{ form.floor_altitude_amsl.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Ceiling Altitude AMSL -->
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.ceiling_altitude_amsl.id_for_label }}" class="form-label">
                                    {{ form.ceiling_altitude_amsl.label }}
                                </label>
                                {{ form.ceiling_altitude_amsl }}
                                {% if form.ceiling_altitude_amsl.help_text %}
                                <div class="form-text">{{ form.ceiling_altitude_amsl.help_text }}</div>
                                {% endif %}
                                {% if form.ceiling_altitude_amsl.errors %}
                                <div class="text-danger small">{{ form.ceiling_altitude_amsl.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Floor Height AGL -->
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.floor_height_agl.id_for_label }}" class="form-label">
                                    {{ form.floor_height_agl.label }}
                                </label>
                                {{ form.floor_height_agl }}
                                {% if form.floor_height_agl.help_text %}
                                <div class="form-text">{{ form.floor_height_agl.help_text }}</div>
                                {% endif %}
                                {% if form.floor_height_agl.errors %}
                                <div class="text-danger small">{{ form.floor_height_agl.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Ceiling Height AGL -->
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.ceiling_height_agl.id_for_label }}" class="form-label">
                                    {{ form.ceiling_height_agl.label }}
                                </label>
                                {{ form.ceiling_height_agl }}
                                {% if form.ceiling_height_agl.help_text %}
                                <div class="form-text">{{ form.ceiling_height_agl.help_text }}</div>
                                {% endif %}
                                {% if form.ceiling_height_agl.errors %}
                                <div class="text-danger small">{{ form.ceiling_height_agl.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Operational Parameters -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-cog me-2"></i>Operational Parameters
                                </h5>
                            </div>

                            <!-- Status -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    {{ form.status.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.status }}
                                {% if form.status.help_text %}
                                <div class="form-text">{{ form.status.help_text }}</div>
                                {% endif %}
                                {% if form.status.errors %}
                                <div class="text-danger small">{{ form.status.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Checkboxes -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check mb-2">
                                    {{ form.rpa_operations_permitted }}
                                    <label class="form-check-label" for="{{ form.rpa_operations_permitted.id_for_label }}">
                                        {{ form.rpa_operations_permitted.label }}
                                    </label>
                                    {% if form.rpa_operations_permitted.help_text %}
                                    <div class="form-text">{{ form.rpa_operations_permitted.help_text }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-check">
                                    {{ form.authorization_required }}
                                    <label class="form-check-label" for="{{ form.authorization_required.id_for_label }}">
                                        {{ form.authorization_required.label }}
                                    </label>
                                    {% if form.authorization_required.help_text %}
                                    <div class="form-text">{{ form.authorization_required.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Effective From -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.effective_from.id_for_label }}" class="form-label">
                                    {{ form.effective_from.label }}
                                </label>
                                {{ form.effective_from }}
                                {% if form.effective_from.help_text %}
                                <div class="form-text">{{ form.effective_from.help_text }}</div>
                                {% endif %}
                                {% if form.effective_from.errors %}
                                <div class="text-danger small">{{ form.effective_from.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Effective Until -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.effective_until.id_for_label }}" class="form-label">
                                    {{ form.effective_until.label }}
                                </label>
                                {{ form.effective_until }}
                                {% if form.effective_until.help_text %}
                                <div class="form-text">{{ form.effective_until.help_text }}</div>
                                {% endif %}
                                {% if form.effective_until.errors %}
                                <div class="text-danger small">{{ form.effective_until.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-address-book me-2"></i>Contact Information
                                </h5>
                            </div>

                            <!-- Controlling Authority -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.controlling_authority.id_for_label }}" class="form-label">
                                    {{ form.controlling_authority.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.controlling_authority }}
                                {% if form.controlling_authority.help_text %}
                                <div class="form-text">{{ form.controlling_authority.help_text }}</div>
                                {% endif %}
                                {% if form.controlling_authority.errors %}
                                <div class="text-danger small">{{ form.controlling_authority.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Contact Frequency -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.contact_frequency.id_for_label }}" class="form-label">
                                    {{ form.contact_frequency.label }}
                                </label>
                                {{ form.contact_frequency }}
                                {% if form.contact_frequency.help_text %}
                                <div class="form-text">{{ form.contact_frequency.help_text }}</div>
                                {% endif %}
                                {% if form.contact_frequency.errors %}
                                <div class="text-danger small">{{ form.contact_frequency.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Contact Phone -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.contact_phone.id_for_label }}" class="form-label">
                                    {{ form.contact_phone.label }}
                                </label>
                                {{ form.contact_phone }}
                                {% if form.contact_phone.help_text %}
                                <div class="form-text">{{ form.contact_phone.help_text }}</div>
                                {% endif %}
                                {% if form.contact_phone.errors %}
                                <div class="text-danger small">{{ form.contact_phone.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Description and Notes -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-file-alt me-2"></i>Description and Notes
                                </h5>
                            </div>

                            <!-- Description -->
                            <div class="col-12 mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">
                                    {{ form.description.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.description }}
                                {% if form.description.help_text %}
                                <div class="form-text">{{ form.description.help_text }}</div>
                                {% endif %}
                                {% if form.description.errors %}
                                <div class="text-danger small">{{ form.description.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Operational Notes -->
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.operational_notes.id_for_label }}" class="form-label">
                                    {{ form.operational_notes.label }}
                                </label>
                                {{ form.operational_notes }}
                                {% if form.operational_notes.help_text %}
                                <div class="form-text">{{ form.operational_notes.help_text }}</div>
                                {% endif %}
                                {% if form.operational_notes.errors %}
                                <div class="text-danger small">{{ form.operational_notes.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- CASA Reference -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.casa_reference.id_for_label }}" class="form-label">
                                    {{ form.casa_reference.label }}
                                </label>
                                {{ form.casa_reference }}
                                {% if form.casa_reference.help_text %}
                                <div class="form-text">{{ form.casa_reference.help_text }}</div>
                                {% endif %}
                                {% if form.casa_reference.errors %}
                                <div class="text-danger small">{{ form.casa_reference.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between pt-3 border-top">
                            <a href="{% url 'airspace:operational_area_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                {% if operational_area %}Update Operational Area{% else %}Create Operational Area{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Area ID validation
    const areaIdField = document.getElementById('{{ form.area_id.id_for_label }}');
    if (areaIdField) {
        areaIdField.addEventListener('input', function() {
            const value = this.value.toUpperCase();
            this.value = value;
            
            // Basic format validation
            const pattern = /^OA-[A-Z0-9]{0,12}$/;
            const isValid = pattern.test(value) && value.length >= 9;
            
            if (value && !isValid) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }

    // Coordinate validation helper
    function validateCoordinate(field, min, max, label) {
        field.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (this.value && (isNaN(value) || value < min || value > max)) {
                this.classList.add('is-invalid');
                this.title = `${label} must be between ${min} and ${max}`;
            } else {
                this.classList.remove('is-invalid');
                this.title = '';
            }
        });
    }

    // Validate latitude and longitude
    const latField = document.getElementById('{{ form.center_latitude.id_for_label }}');
    const lngField = document.getElementById('{{ form.center_longitude.id_for_label }}');
    
    if (latField) validateCoordinate(latField, -90, 90, 'Latitude');
    if (lngField) validateCoordinate(lngField, -180, 180, 'Longitude');
});
</script>
{% endblock %}