{% extends 'aircraft/base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit Step{% else %}Add Step{% endif %} - {{ sop.title }} - Core Operations
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="fas fa-edit"></i>
                    {% if form.instance.pk %}Edit Step {{ form.instance.step_number }}{% else %}Add New Step{% endif %}
                    <small class="text-muted">{{ sop.title }}</small>
                </h2>
                <div>
                    <a href="{% url 'core:sop_steps_list' sop.pk %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Steps
                    </a>
                    <a href="{% url 'core:sop_detail' sop.pk %}" class="btn btn-outline-secondary">
                        <i class="fas fa-eye"></i> View SOP
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- SOP Context Banner -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-light">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">{{ sop.title }}</h6>
                            <small class="text-muted">{{ sop.description|default:"Standard Operating Procedure"|truncatewords:15 }}</small>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if sop.status == 'active' %}
                                <span class="badge bg-success">{{ sop.get_status_display|default:"Active" }}</span>
                            {% elif sop.status == 'draft' %}
                                <span class="badge bg-warning">{{ sop.get_status_display|default:"Draft" }}</span>
                            {% elif sop.status == 'under_review' %}
                                <span class="badge bg-primary">{{ sop.get_status_display|default:"Under Review" }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ sop.get_status_display|default:"Archived" }}</span>
                            {% endif %}
                            <br><small class="text-muted">Version {{ sop.version_number|default:"1.0" }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Main Form -->
            <div class="col-md-12">
                
                <!-- 1. BASIC STEP INFORMATION -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle text-primary"></i> Basic Step Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">Step Title *</label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.title.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="{{ form.step_number.id_for_label }}" class="form-label">Step Number *</label>
                                {{ form.step_number }}
                                {% if form.step_number.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.step_number.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="{{ form.step_type.id_for_label }}" class="form-label">Step Type</label>
                                {{ form.step_type }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Detailed Description *</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.description.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.responsible_role.id_for_label }}" class="form-label">Responsible Role *</label>
                                {{ form.responsible_role }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.duration_estimate.id_for_label }}" class="form-label">Duration Estimate (minutes)</label>
                                {{ form.duration_estimate }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. JSA (JOB SAFETY ANALYSIS) - AUSTRALIAN COMPLIANCE -->
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5><i class="fas fa-shield-alt text-warning"></i> JSA (Job Safety Analysis) - Australian Compliance</h5>
                        <small class="text-muted">Required for Australian workplace safety standards</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.jsa_hazard_identification.id_for_label }}" class="form-label">
                                Hazard Identification <span class="text-danger">*</span>
                            </label>
                            {{ form.jsa_hazard_identification }}
                            <small class="form-text text-muted">Identify all potential hazards: equipment failure, human error, environmental factors, etc.</small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.risk_likelihood.id_for_label }}" class="form-label">Risk Likelihood</label>
                                {{ form.risk_likelihood }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.risk_consequence.id_for_label }}" class="form-label">Risk Consequence</label>
                                {{ form.risk_consequence }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.jsa_risk_rating.id_for_label }}" class="form-label">Overall Risk Rating</label>
                                {{ form.jsa_risk_rating }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.jsa_control_measures.id_for_label }}" class="form-label">
                                Control Measures <span class="text-danger">*</span>
                            </label>
                            {{ form.jsa_control_measures }}
                            <small class="form-text text-muted">Describe specific control measures to mitigate each identified risk</small>
                        </div>
                    </div>
                </div>

                <!-- 3. SAFETY & WARNINGS -->
                <div class="card mb-4 border-danger">
                    <div class="card-header bg-danger bg-opacity-10">
                        <h5><i class="fas fa-exclamation-triangle text-danger"></i> Safety & Warnings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.safety_warnings.id_for_label }}" class="form-label">Safety Warnings</label>
                            {{ form.safety_warnings }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.emergency_procedures.id_for_label }}" class="form-label">Emergency Procedures</label>
                            {{ form.emergency_procedures }}
                        </div>

                        <div class="form-check">
                            {{ form.safety_critical }}
                            <label class="form-check-label" for="{{ form.safety_critical.id_for_label }}">
                                Safety Critical Step
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 4. EQUIPMENT & RESOURCES -->
                <div class="card mb-4 border-info">
                    <div class="card-header bg-info bg-opacity-10">
                        <h5><i class="fas fa-tools text-info"></i> Equipment & Resources</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.required_equipment.id_for_label }}" class="form-label">Required Equipment & Tools</label>
                            {{ form.required_equipment }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.required_personnel.id_for_label }}" class="form-label">Required Personnel</label>
                            {{ form.required_personnel }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.environmental_conditions.id_for_label }}" class="form-label">Environmental Conditions</label>
                            {{ form.environmental_conditions }}
                        </div>
                    </div>
                </div>

                <!-- 5. QUALITY & VERIFICATION -->
                <div class="card mb-4 border-success">
                    <div class="card-header bg-success bg-opacity-10">
                        <h5><i class="fas fa-check-circle text-success"></i> Quality & Verification</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.quality_standards.id_for_label }}" class="form-label">Quality Standards</label>
                            {{ form.quality_standards }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.verification_method.id_for_label }}" class="form-label">Verification Method</label>
                            {{ form.verification_method }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.acceptance_criteria.id_for_label }}" class="form-label">Acceptance Criteria</label>
                            {{ form.acceptance_criteria }}
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.verification_required }}
                                    <label class="form-check-label" for="{{ form.verification_required.id_for_label }}">
                                        Verification Required
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.sign_off_required }}
                                    <label class="form-check-label" for="{{ form.sign_off_required.id_for_label }}">
                                        Supervisor Sign-off Required
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. COMPLIANCE & ADDITIONAL INFORMATION -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-check"></i> Compliance & Additional Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.regulatory_references.id_for_label }}" class="form-label">Regulatory References</label>
                            {{ form.regulatory_references }}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Additional Notes</label>
                            {{ form.notes }}
                        </div>

                        {% if form.prerequisite_steps.field.queryset %}
                        <div class="mb-3">
                            <label class="form-label">Prerequisite Steps</label>
                            {{ form.prerequisite_steps }}
                            <small class="form-text text-muted">Select steps that must be completed before this step</small>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- SUBMIT BUTTONS -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'core:sop_steps_list' sop.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save"></i>
                                    {% if form.instance.pk %}Update Step{% else %}Create Step{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.card-header h5 {
    margin-bottom: 0;
}

.form-label {
    font-weight: 600;
    color: #495057;
}

.text-danger {
    font-weight: 600;
}

.border-warning {
    border-left: 4px solid #ffc107 !important;
}

.border-danger {
    border-left: 4px solid #dc3545 !important;
}

.border-info {
    border-left: 4px solid #0dcaf0 !important;
}

.border-success {
    border-left: 4px solid #198754 !important;
}

.bg-opacity-10 {
    background-color: rgba(var(--bs-bg-opacity), 0.1) !important;
}

.invalid-feedback {
    color: #dc3545;
    font-size: 0.875rem;
}

.form-text {
    color: #6c757d;
    font-size: 0.875rem;
}
</style>
{% endblock %}