{% extends 'aircraft/base.html' %}
{% load static %}

{% block title %}Mission: {{ object.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-tasks"></i> {{ object.name }}</h2>
                    <div class="d-flex align-items-center gap-2 mt-2">
                        {% if object.status == 'active' %}
                            <span class="badge bg-success fs-6">{{ object.get_status_display }}</span>
                        {% elif object.status == 'planning' %}
                            <span class="badge bg-warning fs-6">{{ object.get_status_display }}</span>
                        {% elif object.status == 'approved' %}
                            <span class="badge bg-primary fs-6">{{ object.get_status_display }}</span>
                        {% elif object.status == 'completed' %}
                            <span class="badge bg-secondary fs-6">{{ object.get_status_display }}</span>
                        {% else %}
                            <span class="badge bg-danger fs-6">{{ object.get_status_display }}</span>
                        {% endif %}
                        
                        {% if object.priority == 'high' %}
                            <span class="badge bg-danger">{{ object.get_priority_display }}</span>
                        {% elif object.priority == 'medium' %}
                            <span class="badge bg-warning">{{ object.get_priority_display }}</span>
                        {% else %}
                            <span class="badge bg-success">{{ object.get_priority_display }}</span>
                        {% endif %}
                        
                        <span class="badge bg-info">{{ object.get_mission_type_display }}</span>
                    </div>
                </div>
                <div>
                    <a href="{% url 'flight_operations:mission_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                    <a href="{% url 'flight_operations:mission_update' object.pk %}" class="btn btn-warning">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-cog"></i> Actions
                        </button>
                        <ul class="dropdown-menu">
                            {% if object.status == 'planning' %}
                                <li><a class="dropdown-item" href="#" onclick="updateStatus('approved')">
                                    <i class="fas fa-check"></i> Approve Mission
                                </a></li>
                            {% endif %}
                            {% if object.status == 'approved' %}
                                <li><a class="dropdown-item" href="#" onclick="updateStatus('active')">
                                    <i class="fas fa-play"></i> Activate Mission
                                </a></li>
                            {% endif %}
                            {% if object.status == 'active' %}
                                <li><a class="dropdown-item" href="#" onclick="updateStatus('completed')">
                                    <i class="fas fa-stop"></i> Complete Mission
                                </a></li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'flight_operations:unified_flight_plan_create' %}?mission={{ object.pk }}">
                                <i class="fas fa-route"></i> Create Flight Plan
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'flight_operations:risk_register_create' %}?mission={{ object.pk }}">
                                <i class="fas fa-exclamation-triangle"></i> Add Risk Assessment
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="confirmDelete()">
                                <i class="fas fa-trash"></i> Delete Mission
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-md-8">
            <!-- Mission Overview -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Mission Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Mission Code:</strong> {{ object.mission_code|default:"Not assigned" }}<br>
                            <strong>Type:</strong> {{ object.get_mission_type_display }}<br>
                            <strong>Priority:</strong> {{ object.get_priority_display }}<br>
                            <strong>Status:</strong> {{ object.get_status_display }}<br>
                        </div>
                        <div class="col-md-6">
                            <strong>Created:</strong> {{ object.created_at|date:"M d, Y H:i" }}<br>
                            <strong>Updated:</strong> {{ object.updated_at|date:"M d, Y H:i" }}<br>
                            <strong>Duration:</strong> {{ object.estimated_duration|default:"Not specified" }} hours<br>
                        </div>
                    </div>
                    
                    {% if object.description %}
                        <hr>
                        <strong>Description:</strong><br>
                        <p>{{ object.description|linebreaks }}</p>
                    {% endif %}
                    
                    {% if object.special_requirements %}
                        <hr>
                        <strong>Special Requirements:</strong><br>
                        <p>{{ object.special_requirements|linebreaks }}</p>
                    {% endif %}
                    
                    {% if object.notes %}
                        <hr>
                        <strong>Notes:</strong><br>
                        <p>{{ object.notes|linebreaks }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Schedule -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-calendar"></i> Schedule</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Planned Start:</strong><br>
                            <span class="fs-5">{{ object.planned_start_date|date:"M d, Y H:i" }}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Planned End:</strong><br>
                            <span class="fs-5">
                                {% if object.planned_end_date %}
                                    {{ object.planned_end_date|date:"M d, Y H:i" }}
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    {% if object.weather_requirements %}
                        <hr>
                        <strong>Weather Requirements:</strong><br>
                        <p>{{ object.weather_requirements }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Related Flight Plans -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-route"></i> Flight Plans</h5>
                    <div>
                        <a href="{% url 'flight_operations:unified_flight_plan_create' %}?mission={{ object.pk }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> Add Flight Plan
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if flight_plan_data.total_count > 0 %}
                        <!-- Flight Plan Statistics -->
                        <div class="row mb-3">
                            <div class="col-md-4 text-center">
                                <h4 class="text-primary">{{ flight_plan_data.aircraft_plans.count }}</h4>
                                <small class="text-muted">Aircraft Plans</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <h4 class="text-success">{{ flight_plan_data.drone_plans.count }}</h4>
                                <small class="text-muted">Drone Plans</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <h4 class="text-info">{{ flight_plan_data.total_count }}</h4>
                                <small class="text-muted">Total Plans</small>
                            </div>
                        </div>
                        
                        <!-- Conflict Validation -->
                        {% if validation_result.conflicts %}
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle"></i> Flight Plan Conflicts Detected</h6>
                                <ul class="mb-0">
                                    {% for conflict in validation_result.conflicts %}
                                        <li>{{ conflict.message }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% elif validation_result.is_valid %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> All flight plans validated - no conflicts detected.
                            </div>
                        {% endif %}
                        
                        <!-- Aircraft Flight Plans -->
                        {% if flight_plan_data.aircraft_plans %}
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-plane"></i> Aircraft Flight Plans
                            </h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Flight Plan ID</th>
                                            <th>Aircraft</th>
                                            <th>Route</th>
                                            <th>Pilot in Command</th>
                                            <th>Status</th>
                                            <th>Departure</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for aircraft_plan in flight_plan_data.aircraft_plans %}
                                        <tr>
                                            <td>{{ aircraft_plan.flight_plan_id }}</td>
                                            <td>{{ aircraft_plan.aircraft.registration_mark }}</td>
                                            <td>{{ aircraft_plan.departure_airport }} → {{ aircraft_plan.arrival_airport }}</td>
                                            <td>{{ aircraft_plan.pilot_in_command.user.get_full_name }}</td>
                                            <td>
                                                {% if aircraft_plan.status == 'approved' %}
                                                    <span class="badge bg-success">{{ aircraft_plan.get_status_display }}</span>
                                                {% elif aircraft_plan.status == 'draft' %}
                                                    <span class="badge bg-warning">{{ aircraft_plan.get_status_display }}</span>
                                                {% else %}
                                                    <span class="badge bg-info">{{ aircraft_plan.get_status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ aircraft_plan.planned_departure_time|date:"M d, H:i" }}</td>
                                            <td>
                                                <a href="{% url 'flight_operations:aircraft_flight_plan_detail' aircraft_plan.pk %}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                        
                        <!-- Drone Flight Plans -->
                        {% if flight_plan_data.drone_plans %}
                            <h6 class="text-success mb-2">
                                <i class="fas fa-helicopter"></i> Drone/RPAS Flight Plans
                            </h6>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Flight Plan ID</th>
                                            <th>Drone</th>
                                            <th>Location</th>
                                            <th>Remote Pilot</th>
                                            <th>Status</th>
                                            <th>Departure</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for drone_plan in flight_plan_data.drone_plans %}
                                        <tr>
                                            <td>{{ drone_plan.flight_plan_id }}</td>
                                            <td>{{ drone_plan.drone.registration_mark }}</td>
                                            <td>{{ drone_plan.takeoff_location|truncatechars:30 }}</td>
                                            <td>{{ drone_plan.remote_pilot.user.get_full_name }}</td>
                                            <td>
                                                {% if drone_plan.status == 'approved' %}
                                                    <span class="badge bg-success">{{ drone_plan.get_status_display }}</span>
                                                {% elif drone_plan.status == 'draft' %}
                                                    <span class="badge bg-warning">{{ drone_plan.get_status_display }}</span>
                                                {% else %}
                                                    <span class="badge bg-info">{{ drone_plan.get_status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ drone_plan.planned_departure_time|date:"M d, H:i" }}</td>
                                            <td>
                                                <a href="{% url 'flight_operations:drone_flight_plan_detail' drone_plan.pk %}" 
                                                   class="btn btn-sm btn-outline-success">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                        

                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-route fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Flight Plans Created</h5>
                            <p class="text-muted">Create your first flight plan to begin planning operations.</p>
                            <a href="{% url 'flight_operations:unified_flight_plan_create' %}?mission={{ object.pk }}" 
                               class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create First Flight Plan
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Risk Assessments -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-exclamation-triangle"></i> Risk Assessments</h5>
                    <a href="{% url 'flight_operations:risk_register_create' %}?mission={{ object.pk }}" class="btn btn-sm btn-warning">
                        <i class="fas fa-plus"></i> Add Risk Item
                    </a>
                </div>
                <div class="card-body">
                    {% if object.risk_registers.all %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Risk Description</th>
                                        <th>Category</th>
                                        <th>Level</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for risk in object.risk_registers.all %}
                                    <tr>
                                        <td>{{ risk.risk_description|truncatechars:50 }}</td>
                                        <td>{{ risk.get_risk_category_display }}</td>
                                        <td>
                                            {% if risk.risk_level == 'high' %}
                                                <span class="badge bg-danger">{{ risk.get_risk_level_display }}</span>
                                            {% elif risk.risk_level == 'medium' %}
                                                <span class="badge bg-warning">{{ risk.get_risk_level_display }}</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ risk.get_risk_level_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if risk.status == 'open' %}
                                                <span class="badge bg-danger">{{ risk.get_status_display }}</span>
                                            {% elif risk.status == 'in_progress' %}
                                                <span class="badge bg-warning">{{ risk.get_status_display }}</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ risk.get_status_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'flight_operations:risk_register_detail' risk.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No risk assessments created yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Assignment -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-users"></i> Assignment</h5>
                </div>
                <div class="card-body">
                    <strong>Client:</strong><br>
                    {% if object.client %}
                        {{ object.client.company_name|default:object.client.user.get_full_name }}
                    {% else %}
                        <span class="text-muted">Internal Mission</span>
                    {% endif %}
                    
                    <hr>
                    
                    <strong>Assigned Pilot:</strong><br>
                    {% if object.assigned_pilot %}
                        <div class="d-flex align-items-center">
                            {% if object.assigned_pilot.profile_picture %}
                                <img src="{{ object.assigned_pilot.profile_picture.url }}" 
                                     class="rounded-circle me-2" width="30" height="30">
                            {% endif %}
                            {{ object.assigned_pilot.user.get_full_name }}
                        </div>
                    {% else %}
                        <span class="text-muted">Not assigned</span>
                    {% endif %}
                    
                    {% if object.crew_members.all %}
                        <hr>
                        <strong>Crew Members:</strong><br>
                        {% for crew in object.crew_members.all %}
                            <div class="d-flex align-items-center mb-1">
                                {% if crew.profile_picture %}
                                    <img src="{{ crew.profile_picture.url }}" 
                                         class="rounded-circle me-2" width="25" height="25">
                                {% endif %}
                                <small>{{ crew.user.get_full_name }}</small>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Mission Stats</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-primary">{{ flight_stats.aircraft.total }}</h4>
                            <small class="text-muted">Aircraft Plans</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-success">{{ flight_stats.drone.total }}</h4>
                            <small class="text-muted">Drone Plans</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning">{{ object.risk_registers.count }}</h4>
                            <small class="text-muted">Risk Items</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-warning">{{ object.risk_registers.count }}</h4>
                            <small class="text-muted">Risk Items</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-secondary">0</h4>
                            <small class="text-muted">Flight Logs</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-info">{% if object.jobsafetyassessment %}1{% else %}0{% endif %}</h4>
                            <small class="text-muted">Safety Assessments</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <strong>Mission Created</strong><br>
                                <small class="text-muted">{{ object.created_at|date:"M d, Y H:i" }}</small>
                            </div>
                        </div>
                        
                        {% if object.status != 'planning' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <strong>Status Updated</strong><br>
                                <small class="text-muted">{{ object.updated_at|date:"M d, Y H:i" }}</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Mission Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to update the mission status to <span id="newStatus"></span>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="statusForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_status">
                    <input type="hidden" name="new_status" id="statusValue">
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this mission?</p>
                <p class="text-danger"><strong>This action cannot be undone and will delete all related flight plans, logs, and assessments.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{% url 'flight_operations:mission_delete' object.pk %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Mission</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline-item {
    position: relative;
    margin-bottom: 15px;
}

.timeline-marker {
    position: absolute;
    left: -25px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    top: 5px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: -19px;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #dee2e6;
}

.timeline-content {
    padding-left: 10px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function updateStatus(status) {
    document.getElementById('newStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
    document.getElementById('statusValue').value = status;
    new bootstrap.Modal(document.getElementById('statusModal')).show();
}

function confirmDelete() {
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

$(document).ready(function() {
    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    // Auto-refresh if mission is active
    {% if object.status == 'active' %}
        setTimeout(function() {
            location.reload();
        }, 300000); // Refresh every 5 minutes
    {% endif %}
});
</script>
{% endblock %}